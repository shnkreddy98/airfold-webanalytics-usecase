name: mv_daily_traffic
nodes:
  - aggregate:
      sql: |
        SELECT
          toDate(timestamp) AS event_date,
          city,
          device_type,
          COUNT(session_id) AS no_of_sessions,
          COUNT(DISTINCT user_id) AS no_of_users,
          COUNTIf(is_new_user=1) AS no_of_new_users,
          SUM(duration) AS total_time_spent,
          COUNT() AS pageviews,
          COUNTIf(conversion_flag = 1) AS conversions,
        FROM web_events
        GROUP BY event_date, city, device_type
to: daily_traffic_metrics
refresh:
  strategy: append
  interval: EVERY 1 MONTH
